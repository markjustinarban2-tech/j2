<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>J2 Nexus ‚Äî Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Define Variables for consistency */
        :root {
            --primary-color: #4f46e5; /* Indigo */
            --light-bg: #f3f4f6;
            --text-color: #1f2937;
            --shadow-light: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-hover: 0 8px 16px rgba(0,0,0,0.1);
            --card-background: #ffffff;
            --success-color: #22c55e; /* Green */
        }

        *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins', sans-serif}
        body{background:var(--light-bg);color:var(--text-color)}
        
        /* Header */
        header{
            background:#fff;
            padding:18px 32px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            box-shadow:var(--shadow-light);
            position:sticky;top:0;z-index:50
        }
        .logo{font-size:26px;font-weight:700;color:var(--primary-color);text-decoration:none}
        
        /* Combined navigation and profile container */
        .nav-content {
            display: flex;
            align-items: center;
            gap: 25px;
        }
        
        /* New container for navigation links (with corrected spacing) */
        .nav-links {
            display: flex;
            align-items: center;
            gap: 25px; 
        }

        .nav-links a{
            text-decoration:none;
            color:#4b5563;
            font-weight:500;
            transition:color 0.2s;
        }
        .nav-links a:hover{color:var(--primary-color)}

        /* --- CART ICON STYLE --- */
        .cart-icon-container {
            position: relative;
            padding: 0 10px;
            cursor: pointer;
        }
        .cart-icon-container i {
            font-size: 20px;
            color: var(--primary-color);
        }
        #cartCount {
            position: absolute;
            top: -8px;
            right: -5px;
            background: #ef4444; 
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
        }

        /* User Profile in Header */
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-left: 20px;
            border-left: 1px solid #e5e7eb;
        }
        .user-profile-header img {
            height: 35px;
            width: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }
        .username-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-color);
        }
        .logout-btn { 
            background: #ef4444; 
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .logout-btn:hover { background: #dc2626; }

        /* Hero */
        .hero{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:100px 50px;
            background:#eef2ff;
        }
        .hero div { max-width: 500px; }
        .hero h1{font-size:48px;font-weight:800;margin-bottom:16px;line-height:1.2;}
        .hero p{font-size:18px;color:#4b5563;margin-bottom:30px}
        .hero button{
            padding:14px 28px;
            background:var(--primary-color);
            border:0;
            color:#fff;
            border-radius:10px;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            transition:opacity 0.2s, transform 0.2s;
        }
        .hero button:hover{opacity:0.9; transform: translateY(-1px);}
        .hero img{width:500px;height:400px;object-fit:cover;border-radius:20px;box-shadow:0 15px 40px rgba(79, 70, 229, 0.3);}

        /* Sections */
        .section{padding:80px 50px}
        .section h2{font-size:32px;font-weight:700;margin-bottom:30px;text-align:center;}

        /* Categories */
        .categories{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:30px}
        .category-card{
            background:var(--card-background);
            padding:25px;
            border-radius:14px;
            text-align:center;
            box-shadow:var(--shadow-light);
            cursor:pointer;
            transition:0.2s;
        }
        .category-card:hover{transform:translateY(-5px);box-shadow:var(--shadow-hover);}
        .category-card img{width:90px;height:90px;object-fit:cover;margin-bottom:15px;border-radius:50%; border: 3px solid var(--primary-color);}
        .category-card h3{font-weight:600; color:var(--text-color);}

        /* Featured products */
        .products{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:30px}
        .product-card{
            background:var(--card-background);
            border-radius:14px;
            box-shadow:var(--shadow-light);
            padding:16px;
            transition:0.2s;
            min-height: 420px; /* Increased height to fit new controls */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .product-card:hover{transform:translateY(-5px); box-shadow:var(--shadow-hover);}
        .product-card img{width:100%;height:220px;object-fit:cover;border-radius:10px;margin-bottom:15px}
        .product-card h3{font-size:20px;font-weight:600;margin-bottom:6px}
        .product-card p{color:#6b7280;font-size:15px;margin-bottom:10px}
        .price{font-size:20px;font-weight:700;color:#ef4444;}
        
        /* --- NEW: Cart Controls Style --- */
        .cart-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        .cart-controls input[type="number"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 70px;
            text-align: center;
            font-size: 14px;
        }
        .cart-controls button {
            background: var(--success-color); 
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            flex-grow: 1; /* Make the button fill available space */
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cart-controls button:hover:not(:disabled) { background: #15803d; }
        .cart-controls button i { margin-right: 8px; }
        .cart-controls button:disabled {
            background: #d1d5db; /* Light gray when disabled */
            cursor: not-allowed;
        }

        /* Footer */
        footer{margin-top:0;background:#1f2937;color:#fff;padding:40px;text-align:center;font-size:14px}

        /* Media Queries */
        @media (max-width: 900px) {
            .hero { flex-direction: column; text-align: center; padding: 60px 20px; }
            .hero img { width: 100%; max-width: 400px; margin-top: 30px; }
            .section { padding: 40px 20px; }
            header { padding: 15px 20px; }
            .nav-content { flex-direction: column; align-items: flex-end; gap: 10px; }
            .nav-links { gap: 15px; } 
            .user-profile-header { padding-left: 0; border-left: none; }
            .cart-controls { flex-direction: column; }
            .cart-controls input { width: 100%; }
        }
    </style>
</head>
<body>

    <header>
        <a href="user_dashboard.html" class="logo">J2 Nexus</a>
        <div class="nav-content">
            <div class="nav-links">
                <a href="user_dashboard.html">Home</a>
                <a href="#categories">Categories</a>
                <a href="#products">Products</a>
                <a href="contact.html">Contact</a>
                <a href="cart.html" class="cart-link" title="View Shopping Cart">
                    <div class="cart-icon-container">
                        <i class="fas fa-shopping-cart"></i> 
                        <span id="cartCount">0</span>
                    </div>
                </a>
            </div>
            <div class="user-profile-header">
                <img src="https://www.gravatar.com/avatar?d=mp" alt="User Profile" />
                <span class="username-text" id="userName">Loading...</span>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </div>
    </header>

    <section class="hero">
        <div>
            <h1 id="welcomeTitle">Welcome, User!</h1>
            <p>Discover the latest products, hottest deals, and premium quality items ‚Äî all in one place.</p>
            <button>Shop Now</button>
        </div>
        <img src="https://images.pexels.com/photos/3965545/pexels-photo-3965545.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" />
    </section>

    <section class="section" id="categories">
        <h2>Shop by Category</h2>
        <div class="categories">
            <div class="category-card">
                <img src="https://images.pexels.com/photos/47261/pexels-photo-47261.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Smartphones" />
                <h3>Smartphones</h3>
            </div>
            
            <div class="category-card">
                <img src="https://images.pexels.com/photos/2034335/pexels-photo-2034335.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Wearables" />
                <h3>Wearables</h3>
            </div>
            
            <div class="category-card">
                <img src="https://images.pexels.com/photos/1571460/pexels-photo-1571460.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Smart Home Devices" />
                <h3>Smart Home Devices</h3>
            </div>
 
        </div>
    </section>

    <section class="section" id="products">
        <h2>Featured Products</h2>
        <div class="products" id="dynamicProductGrid"> 
            <div id="productLoadingStatus" style="text-align: center; color: #6b7280; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Loading latest products...
            </div>
        </div>
    </section>

    <footer>
        ¬© 2025 J2 Nexus ‚Äî All Rights Reserved
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        // üü¢ NEW: Import Firestore services for CRUD operations and real-time listening
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // **IMPORTANT:** Use your actual Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAKYSKoY23MbBX9g2PrXoxSuKtTEpaNxcw",
            authDomain: "j2nexuss-a7b99.firebaseapp.com",
            projectId: "j2nexuss-a7b99",
            storageBucket: "j2nexuss-a7b99.firebasestorage.app",
            messagingSenderId: "456617087462",
            appId: "1:456617087462:web:be5dba59b5a117cab38627",
            measurementId: "G-9JQEGSHWHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); 

        // --- Global State & Elements ---
        let currentUserId = null;
        const userNameEl = document.getElementById("userName");
        const welcomeTitleEl = document.getElementById("welcomeTitle");
        const logoutBtn = document.getElementById("logoutBtn");
        const dynamicProductGrid = document.getElementById('dynamicProductGrid');
        // üü¢ NEW: Cart Count Element
        const cartCountElement = document.getElementById('cartCount');

        // --- 1. Real-Time Cart Counter (Listener) ---
        function subscribeToCartUpdates(userId) {
            // Reference to the carts subcollection: users/{userId}/carts
            const cartCollectionRef = collection(db, "users", userId, "carts");
            
            // onSnapshot provides real-time updates for the cart count
            onSnapshot(cartCollectionRef, (snapshot) => {
                let totalItemsInCart = 0;
                snapshot.forEach((doc) => {
                    totalItemsInCart += doc.data().quantity;
                });
                cartCountElement.textContent = totalItemsInCart;
            }, (error) => {
                console.error("Error listening to cart:", error);
                cartCountElement.textContent = 'Err';
            });
        }
        
        // --- 2. Add to Cart Functionality ---
        window.addToCart = async function(productId, price, name, maxStock) {
            if (!currentUserId) {
                alert("Please log in to add items to your cart.");
                return;
            }

            // Get the quantity from the input field specific to this product
            const quantityInput = document.getElementById(`qty_${productId}`);
            let quantityToAdd = parseInt(quantityInput.value) || 1;

            if (quantityToAdd <= 0 || maxStock <= 0) {
                 alert("Item is out of stock or invalid quantity selected.");
                 return;
            }
            if (quantityToAdd > maxStock) quantityToAdd = maxStock; // Max out at available stock

            // Reference to the specific cart item document: users/{userId}/carts/{productId}
            const cartItemRef = doc(db, "users", currentUserId, "carts", productId);

            try {
                // Check if item already exists in the cart
                const cartSnapshot = await getDoc(cartItemRef);
                let finalQuantity = quantityToAdd;
                let message = "";

                if (cartSnapshot.exists()) {
                    const existingQuantity = cartSnapshot.data().quantity;
                    finalQuantity = existingQuantity + quantityToAdd;
                }
                
                // Check against overall stock limit
                if (finalQuantity > maxStock) {
                    finalQuantity = maxStock;
                    const amountAdded = finalQuantity - (cartSnapshot.exists() ? cartSnapshot.data().quantity : 0);
                    
                    if (amountAdded > 0) {
                         message = `Added ${amountAdded} more of ${name}. Total quantity limited by stock (${maxStock}).`;
                    } else {
                         message = `${name} is already at maximum quantity (${maxStock}) in your cart.`;
                    }
                } else {
                    message = `Successfully added ${quantityToAdd} of ${name} to cart!`;
                }

                // If final quantity is 0 or less (shouldn't happen here), skip setDoc
                if (finalQuantity > 0) {
                    await setDoc(cartItemRef, {
                        productId: productId,
                        name: name,
                        price: price, // Price at the time of adding
                        quantity: finalQuantity,
                        addedAt: new Date().toISOString()
                    });
                }
                
                alert(message);
                quantityInput.value = 1; // Reset input after successful add/update

            } catch (error) {
                console.error("Error adding to cart:", error);
                alert("Failed to add item to cart. Please try again later.");
            }
        }

        // --- 3. Load All Products (Updated to include Cart Controls) ---
        async function loadAllProducts() {
            const loadingStatusEl = document.getElementById('productLoadingStatus');
            dynamicProductGrid.innerHTML = '<div id="productLoadingStatus" style="text-align: center; color: #6b7280; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading latest products...</div>';
            
            try {
                const querySnapshot = await getDocs(collection(db, "products"));

                if (querySnapshot.empty) {
                    dynamicProductGrid.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No products are currently listed in the marketplace. Check back soon!</p>';
                    return;
                }

                let productsHTML = '';
                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    const productId = doc.id;
                    const stock = product.stock || 0;
                    const price = product.price.toFixed(2);
                    
                    const imageUrl = product.imageURL && product.imageURL !== 'placeholder.jpg' 
                                     ? product.imageURL 
                                     : 'https://via.placeholder.com/280x220?text=J2+Nexus+Product';
                    
                    // Determine if the product is out of stock
                    const outOfStock = stock <= 0;
                    const stockText = outOfStock ? 'Out of Stock' : `Stock: ${stock}`;
                    const stockColor = outOfStock ? '#ef4444' : '#10b981';

                    // üü¢ NEW: Product card with cart controls
                    productsHTML += `
                        <div class="product-card">
                            <div>
                                <img src="${imageUrl}" alt="${product.name}" />
                                <h3>${product.name}</h3>
                                <p>${product.description.substring(0, 50)}...</p>
                                <div class="price">‚Ç±${product.price.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                                <p style="font-size: 12px; color: ${stockColor}; margin-top: 5px;">${stockText}</p>
                            </div>
                            
                            <div class="cart-controls">
                                <input type="number" 
                                       id="qty_${productId}" 
                                       value="1" 
                                       min="1" 
                                       max="${stock}" 
                                       ${outOfStock ? 'disabled' : ''} 
                                />
                                <button 
                                    onclick="addToCart('${productId}', ${price}, '${product.name}', ${stock})"
                                    ${outOfStock ? 'disabled' : ''}
                                >
                                    <i class="fas fa-cart-plus"></i> ${outOfStock ? 'Sold Out' : 'Add to Cart'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                dynamicProductGrid.innerHTML = productsHTML;

            } catch (error) {
                console.error("Error loading all products: ", error);
                dynamicProductGrid.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px;">‚ö†Ô∏è Error loading products. Please check console for details.</div>';
            }
        }
        // --- END loadAllProducts function ---


        // Check authentication state on page load
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid; // üü¢ Set global user ID
                const email = user.email;
                const displayName = email.split('@')[0];
                userNameEl.textContent = displayName; 
                welcomeTitleEl.textContent = `Welcome, ${displayName}!`;
                
                loadAllProducts(); 
                subscribeToCartUpdates(currentUserId); // üü¢ Start cart listener
                
            } else {
                window.location.href = "login.html";
            }
        });

        // Logout functionality
        logoutBtn.addEventListener("click", async () => {
            try {
                await signOut(auth);
                window.location.href = "login.html";
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });
    </script>

</body>
</html>