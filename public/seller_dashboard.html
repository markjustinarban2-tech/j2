<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seller Dashboard - J2 Nexus</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Define Variables for consistency */
        :root {
            --primary-color: #4f46e5; /* Indigo */
            --secondary-color: #6366f1; /* Light Indigo */
            --light-bg: #f3f4f6;
            --text-color: #1f2937;
            --subtle-text: #6b7280;
            --card-background: #ffffff;
            --shadow-light: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        }

        /* ===== Global Reset and Typography ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: var(--light-bg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: var(--text-color);
        }

        /* ===== Header & Navigation (Matching Index Style) ===== */
        header {
            background: var(--card-background);
            padding: 18px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-light);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .logo {
            font-size: 26px;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-actions button {
            padding: 8px 18px;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.2s, transform 0.1s;
            border: none;
            cursor: pointer;
        }

        .header-actions button:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        /* ===== Main Content and Layout ===== */
        main {
            flex: 1;
            padding: 40px 32px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }
        
        .dashboard-header {
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-color);
        }

        .dashboard-header p {
            color: var(--subtle-text);
            font-size: 16px;
        }

        /* ===== Dashboard Tabs Navigation ===== */
        .dashboard-nav {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            color: var(--subtle-text);
            cursor: pointer;
            transition: color 0.2s, border-bottom 0.2s;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        /* ===== Tab Content Display ===== */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        /* ===== Card Styles (For Overview) ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--card-background);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            border-left: 5px solid var(--primary-color);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--subtle-text);
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 30px;
            font-weight: 800;
            color: var(--text-color);
        }
        
        /* ==================================== */
        /* ===== ADD PRODUCT FORM STYLES ====== */
        /* ==================================== */

        .add-product-form {
            background: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            max-width: 600px; 
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .add-product-form label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .add-product-form input[type="text"],
        .add-product-form input[type="number"],
        .add-product-form input[type="url"],
        .add-product-form textarea,
        .add-product-form select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .add-product-form input:focus,
        .add-product-form textarea:focus,
        .add-product-form select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .add-product-form button[type="submit"] {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: var(--primary-color);
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            margin-top: 10px;
        }

        .add-product-form button[type="submit"]:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        
        /* ==================================== */
        /* ===== MY PRODUCTS LIST STYLES ====== */
        /* ==================================== */
        .product-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 250px; /* Adjusted height to fit update/delete buttons */
            border-left: 4px solid #f97316; /* Orange border for products */
        }

        .product-card h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .product-card p {
            font-size: 14px;
            color: var(--subtle-text);
        }
        
        .product-footer {
            margin-top: 15px;
            border-top: 1px dashed #e5e7eb;
            padding-top: 10px;
        }

        .product-card .price {
            font-size: 22px;
            font-weight: 700;
            color: #10b981; /* Green color for price */
        }

        .product-card .stock {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo">J2 Nexus Seller</a>
        <div class="header-actions">
            <span id="sellerInfo" style="color: var(--text-color); font-weight: 500;">Loading...</span>
            <button id="logoutButton">Logout</button>
        </div>
    </header>

    <main>
        <div class="dashboard-header">
            <h1>Seller Dashboard</h1>
            <p>Manage your sales, products, and orders here.</p>
        </div>

        <div class="dashboard-nav">
            <button class="tab-button active" data-tab="overview">Overview</button>
            <button class="tab-button" data-tab="products">My Products</button>
            <button class="tab-button" data-tab="addProduct">Add Product</button>
            <button class="tab-button" data-tab="orders">Orders</button>
        </div>

        <div id="overview" class="tab-content active">
            <h2>üìä Sales Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Revenue</h3>
                    <p>$<span id="totalRevenue">0.00</span></p>
                </div>
                <div class="stat-card">
                    <h3>Pending Orders</h3>
                    <p><span id="pendingOrders">0</span></p>
                </div>
                <div class="stat-card">
                    <h3>Total Products</h3>
                    <p><span id="totalProducts">0</span></p>
                </div>
                <div class="stat-card">
                    <h3>Product Views</h3>
                    <p><span id="productViews">0</span></p>
                </div>
            </div>
            <h2 style="margin-top: 40px;">Recent Activity</h2>
            <p style="color: var(--subtle-text);">No recent activity to display.</p>
        </div>

        <div id="products" class="tab-content">
            <h2>üõçÔ∏è My Active Products</h2>
            <div id="sellerProductsList" class="product-list-container">
                <p>Loading your products...</p>
            </div>
        </div>

        <div id="addProduct" class="tab-content">
            <h2>‚ûï Add New Product Listing</h2>
            <form id="addProductForm" class="add-product-form">
                <div class="form-group">
                    <label for="productName">Product Name</label>
                    <input type="text" id="productName" name="productName" required>
                </div>
                <div class="form-group">
                    <label for="productDescription">Description</label>
                    <textarea id="productDescription" name="productDescription" rows="4" required></textarea>
                </div>
                <div class="form-group-row">
                    <div class="form-group">
                        <label for="productPrice">Price ($)</label>
                        <input type="number" id="productPrice" name="productPrice" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="productStock">Stock Quantity</label>
                        <input type="number" id="productStock" name="productStock" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="productCategory">Category</label>
                    <select id="productCategory" name="productCategory" required>
                        <option value="">Select a category</option>
                        
                        <option value="Smartphones">Smartphones</option> 
                        <option value="Wearables">Wearables</option>
                        <option value="Smart Home Devices">Smart Home Devices</option>
                        
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productImageURL">Image URL (Optional)</label>
                    <input type="url" id="productImageURL" name="productImageURL" placeholder="https://example.com/image.jpg">
                </div>
                
                <button type="submit" id="submitProductBtn">Publish Product</button>
                <p id="productStatusMessage" class="status-message"></p>
            </form>
        </div>

        <div id="orders" class="tab-content">
            <h2>üì¶ Customer Orders</h2>
            <p style="color: var(--subtle-text);">This section will show the list of orders made by users for your products.</p>
        </div>

    </main>

    <footer>
        <p style="text-align: center; color: var(--subtle-text); font-size: 12px; margin-top: 40px;">
            J2 Nexus Seller Tools | &copy; 2025
        </p>
    </footer>

    <script type="module">
        // Import Firebase services - INCLUDING deleteDoc and updateDoc
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- 1. Firebase Configuration (REPLACE with your actual config) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAKYSKoY23MbBX9g2PrXoxSuKtTEpaNxcw",
            authDomain: "j2nexuss-a7b99.firebaseapp.com",
            projectId: "j2nexuss-a7b99",
            storageBucket: "j2nexuss-a7b99.firebasestorage.app",
            messagingSenderId: "456617087462",
            appId: "1:456617087462:web:be5dba59b5a117cab38627",
            measurementId: "G-9JQEGSHWHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. Global Variables and DOM Elements ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const logoutButton = document.getElementById('logoutButton');
        const addProductForm = document.getElementById('addProductForm');
        const productStatusMessage = document.getElementById('productStatusMessage');
        const sellerProductsList = document.getElementById('sellerProductsList');
        const totalProductsEl = document.getElementById('totalProducts');
        const sellerInfoEl = document.getElementById('sellerInfo');
        let currentUserID = null;

        // --- 3. Tab Switching Logic ---
        function switchTab(tabId) {
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // --- 4. Product Submission Function ---
        async function addProduct(e) {
            e.preventDefault();

            if (!currentUserID) {
                productStatusMessage.textContent = '‚ùå Error: You must be logged in to add a product.';
                productStatusMessage.style.backgroundColor = '#fecaca';
                productStatusMessage.style.color = '#dc2626';
                productStatusMessage.style.display = 'block';
                return;
            }

            productStatusMessage.textContent = 'Publishing product...';
            productStatusMessage.style.backgroundColor = '#e0f2fe';
            productStatusMessage.style.color = '#2563eb';
            productStatusMessage.style.display = 'block';
            
            // Get form data
            const productData = {
                sellerId: currentUserID, // IMPORTANT: Link product to the seller
                name: document.getElementById('productName').value.trim(),
                description: document.getElementById('productDescription').value.trim(),
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                category: document.getElementById('productCategory').value,
                imageURL: document.getElementById('productImageURL').value.trim() || 'placeholder.jpg',
                createdAt: new Date(),
                status: 'active'
            };

            try {
                const docRef = await addDoc(collection(db, "products"), productData);
                
                productStatusMessage.textContent = `‚úÖ Product "${productData.name}" published!`;
                productStatusMessage.style.backgroundColor = '#d1fae5';
                productStatusMessage.style.color = '#059669';
                
                addProductForm.reset();
                loadSellerProducts(currentUserID); // Refresh the product list and stats
            } catch (error) {
                console.error("Error adding product: ", error);
                productStatusMessage.textContent = `‚ùå Failed to publish product: ${error.message}`;
                productStatusMessage.style.backgroundColor = '#fecaca';
                productStatusMessage.style.color = '#dc2626';
            }

            setTimeout(() => {
                productStatusMessage.style.display = 'none';
            }, 5000);
        }

        addProductForm.addEventListener('submit', addProduct);


        // --- 5. Product Display Function (INCLUDES Stock Update/Delete UI) ---
        async function loadSellerProducts(sellerId) {
            sellerProductsList.innerHTML = '<p style="text-align: center;">Loading products...</p>';
            
            try {
                // Query the 'products' collection where the sellerId matches the current user's UID
                const q = query(collection(db, "products"), where("sellerId", "==", sellerId));
                const querySnapshot = await getDocs(q);
                const totalCount = querySnapshot.size;
                totalProductsEl.textContent = totalCount; // Update the overview stat

                if (querySnapshot.empty) {
                    sellerProductsList.innerHTML = '<p style="color: var(--subtle-text); text-align: center;">You have not listed any products yet. Go to "Add Product" to get started!</p>';
                    return;
                }

                let productsHTML = '';
                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    productsHTML += `
                        <div class="product-card">
                            <div>
                                <h3>${product.name}</h3>
                                <p>Category: ${product.category}</p>
                                <p style="font-size: 13px; margin-top: 8px; color: #4f46e5;">
                                    <strong>Product ID:</strong> 
                                    <span style="font-family: monospace;">${doc.id}</span>
                                </p>
                            </div>
                            
                            <div class="product-footer">
                                <p class="price">$${product.price.toFixed(2)}</p>
                                <p class="stock">Current Stock: <strong id="stock-${doc.id}">${product.stock}</strong></p>
                                
                                <div style="display: flex; gap: 5px; margin-top: 10px; align-items: center;">
                                    <input 
                                        type="number" 
                                        id="newStock-${doc.id}" 
                                        min="0" 
                                        placeholder="New Stock" 
                                        value="${product.stock}" 
                                        style="width: 100px; padding: 5px; border: 1px solid #d1d5db; border-radius: 4px;">
                                    
                                    <button 
                                        class="update-stock-btn" 
                                        data-product-id="${doc.id}" 
                                        style="
                                            background: #10b981; 
                                            color: white; 
                                            border: none; 
                                            padding: 6px 10px; 
                                            border-radius: 6px; 
                                            cursor: pointer;
                                            font-size: 14px;
                                            white-space: nowrap;
                                        ">
                                        Update Stock
                                    </button>
                                </div>

                                <button class="delete-btn" data-product-id="${doc.id}" style="
                                    background: #ef4444; 
                                    color: white; 
                                    border: none; 
                                    padding: 5px 10px; 
                                    border-radius: 6px; 
                                    cursor: pointer;
                                    font-size: 14px;
                                    margin-top: 10px;
                                ">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                });
                sellerProductsList.innerHTML = productsHTML;
            } catch (error) {
                console.error("Error loading seller products: ", error);
                sellerProductsList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading your products. Check your console for details.</p>';
            }
        }
        
        // --- 6. Product Deletion Function ---
        async function deleteProduct(productId) {
            if (!confirm("Are you sure you want to delete this product? This action cannot be undone.")) {
                return;
            }

            try {
                const productRef = doc(db, "products", productId);
                await deleteDoc(productRef);

                alert(`Product ${productId.substring(0, 8)}... deleted successfully.`);
                
                // Reload the product list to show the change immediately
                loadSellerProducts(currentUserID);

            } catch (error) {
                console.error("Error deleting product:", error);
                alert(`Failed to delete product: ${error.message}`);
            }
        }
        
        // --- 7. Product Stock Update Function ---
        async function updateProductStock(productId, newStockValue) {
            if (isNaN(newStockValue) || newStockValue < 0) {
                alert("Please enter a valid, non-negative stock quantity.");
                return;
            }
            
            try {
                const productRef = doc(db, "products", productId);
                
                await updateDoc(productRef, {
                    stock: newStockValue
                });

                // INSTANT UI FEEDBACK: Update the stock display without full reload
                document.getElementById(`stock-${productId}`).textContent = newStockValue;
                
                alert(`Stock for Product ${productId.substring(0, 8)}... updated to ${newStockValue}.`);

            } catch (error) {
                console.error("Error updating product stock:", error);
                alert(`Failed to update stock: ${error.message}`);
            }
        }
        
        // --- 8. Event Listener Delegation for Update and Delete Buttons ---
        sellerProductsList.addEventListener('click', (e) => {
            // 1. Check for Delete Button
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const productIdToDelete = deleteButton.dataset.productId;
                deleteProduct(productIdToDelete);
                return; 
            }

            // 2. Check for Update Stock Button
            const updateButton = e.target.closest('.update-stock-btn');
            if (updateButton) {
                const productIdToUpdate = updateButton.dataset.productId;
                const newStockInput = document.getElementById(`newStock-${productIdToUpdate}`);
                const newStockValue = parseInt(newStockInput.value);

                updateProductStock(productIdToUpdate, newStockValue);
            }
        });

        // --- 9. Logout Function ---
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'login.html'; // Redirect to login page
            } catch (error) {
                console.error("Error signing out: ", error);
                alert("Failed to log out.");
            }
        });

        // --- 10. Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserID = user.uid;
                sellerInfoEl.textContent = `Seller ID: ${user.uid.substring(0, 8)}...`;
                
                // Fetch seller name/profile (optional)
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists() && userDoc.data().name) {
                        sellerInfoEl.textContent = `Welcome, ${userDoc.data().name}!`;
                    }
                } catch (e) {
                    console.warn("Could not fetch seller profile.", e);
                }
                
                // Load products specific to this seller
                loadSellerProducts(currentUserID); 
                
            } else {
                // No user is signed in, redirect
                window.location.href = 'login.html'; 
            }
        });

    </script>
</body>
</html>